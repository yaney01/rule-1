// @key @å¥¶èŒ¶å§ update 2023.4.28 -2 å‹ç¼©ä¼˜åŒ–é€Ÿåº¦ å¯èƒ½ï¼Ÿ æµ‹è¯•æœªå‹ç¼©ç‰ˆåœ¨name_dev è¯´æ˜ï¼š https://github.com/Keywos/rule
const $=$substore;const{isLoon:isLoon,isSurge:isSurge,isQX:isQX}=$substore.env;const target=isLoon?"Loon":isSurge?"Surge":isQX?"QX":undefined;const timeout=$arguments["timeout"]?$arguments["timeout"]:800;const flag=$arguments["flag"];const batch_size=$arguments["batch"]?$arguments["batch"]:20;async function operator(e){const t=new Date;console.log("åˆå§‹èŠ‚ç‚¹æ•° = "+e.length);let o=0;while(o<e.length){const t=e.slice(o,o+batch_size);await Promise.allSettled(t.map((async e=>{try{const t=await queryDNSInfo(e.server);const o=await queryIpApi(e);e.name=flag?getFlagEmoji(o.countryCode)+" "+(t===o.query?"ç›´è¿":"ä¸­è½¬")+"â†’"+o.country:o.country;e.qc=t+"|"+o.query}catch(e){console.log(`err = ${e}`)}})));o+=batch_size}e=removeDuplicateName(e);const n=processProxies(e);console.log(`å»é‡åä¸ªæ•° = ${e.length}`);e=removeqcName(e);const s=new Date;const c=s.getTime()-t.getTime();console.log(`æ–¹æ³•æ€»è€—æ—¶ = ${c/1e3} ç§’`);return e}async function queryDNSInfo(e){return new Promise(((t,o)=>{const n=e;const s=`http://223.5.5.5/resolve?name=${e}&type=A&short=1`;$.http.get({url:s}).then((e=>{const o=JSON.parse(e.body);if(o.length>0){t(o[0])}else{t(n)}})).catch((e=>{console.log("dns = "+e);o(e)}))}))}async function queryIpApi(e){return new Promise(((t,o)=>{const n=`http://ip-api.com/json?lang=zh-CN&fields=status,message,country,countryCode,city,query`;let s=ProxyUtils.produce([e],target);if(isLoon){s=s.substring(s.indexOf("=")+1)}const c={policy:s.substring(s.lastIndexOf("=")+1)};const r=new Promise(((e,t)=>{setTimeout((()=>{t(new Error("è¯·æ±‚è¶…æ—¶,ä¸¢å¼ƒèŠ‚ç‚¹"))}),timeout)}));const a=$.http.get({url:n,opts:c,node:s,"policy-descriptor":s}).then((e=>{const n=JSON.parse(e.body);if(n.status==="success"){t(n)}else{o(new Error(n.message))}})).catch((e=>{console.log("api = "+e);o(e)}));Promise.race([r,a]).catch((e=>{o(e)}))}))}function removeDuplicateName(e){const t=new Set;const o=[];for(const n of e){if(n.qc&&!t.has(n.qc)){t.add(n.qc);o.push(n)}}return o}function removeqcName(e){const t=new Set;const o=[];for(const n of e){if(!t.has(n.qc)){t.add(n.qc);const e={...n};delete e.qc;o.push(e)}}return o}function processProxies(e){const t=e.reduce(((e,t)=>{const o=e.find((e=>e.name===t.name));if(o){o.count++;o.items.push({...t,name:`${t.name} ${o.count.toString().padStart(2,"0")}`})}else{e.push({name:t.name,count:1,items:[{...t,name:`${t.name} 01`}]})}return e}),[]);const o=t.flatMap((e=>e.items));e.splice(0,e.length,...o);return e}function getFlagEmoji(e){const t=e.toUpperCase().split("").map((e=>127397+e.charCodeAt()));return String.fromCodePoint(...t).replace(/ğŸ‡¹ğŸ‡¼/g,"ğŸ‡¨ğŸ‡³")}